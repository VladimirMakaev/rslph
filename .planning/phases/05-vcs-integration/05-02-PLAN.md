---
phase: 05-vcs-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/build/state.rs
  - src/build/iteration.rs
  - src/vcs/sapling.rs
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Commit message includes project name captured at BuildContext construction"
    - "Sapling commit returns actual commit hash via sl log after commit"
  artifacts:
    - path: src/build/state.rs
      provides: "BuildContext with project_name field"
      contains: "project_name: String"
    - path: src/build/iteration.rs
      provides: "Iteration commit with project name from context"
      contains: "ctx.project_name"
    - path: src/vcs/sapling.rs
      provides: "Sapling commit hash retrieval via sl log"
      contains: "sl log"
  key_links:
    - from: src/build/iteration.rs
      to: ctx.project_name
      via: "format_iteration_commit call"
      pattern: "format_iteration_commit\\(&ctx\\.project_name"
    - from: src/vcs/sapling.rs
      to: "sl log command"
      via: "post-commit hash lookup"
      pattern: "sl.*log.*-l.*1"
---

<objective>
Fix two UAT-diagnosed bugs in VCS integration: empty project name in commit messages and "unknown" hash for Sapling commits.

Purpose: Address gaps identified in 05-UAT.md that prevent VCS integration from working correctly.
Output: Both bugs fixed, VCS commit messages and hash logging work as expected.
</objective>

<context>
@.planning/phases/05-vcs-integration/05-UAT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Store project name in BuildContext</name>
  <files>src/build/state.rs</files>
  <action>
Add `project_name: String` field to BuildContext struct.
Capture `progress.name.clone()` at construction time.

This ensures the project name is preserved from the original progress file,
regardless of what Claude returns in its response.
  </action>
  <verify>cargo build</verify>
  <done>
BuildContext has project_name field captured at construction from progress.name
  </done>
</task>

<task type="auto">
  <name>Task 2: Use stored project name for commits</name>
  <files>src/build/iteration.rs</files>
  <action>
Change format_iteration_commit call from:
`format_iteration_commit(&updated_progress.name, ...)`

To:
`format_iteration_commit(&ctx.project_name, ...)`
  </action>
  <verify>cargo build && cargo test</verify>
  <done>
Commit message uses ctx.project_name (captured at construction) instead of updated_progress.name
  </done>
</task>

<task type="auto">
  <name>Task 3: Fix Sapling commit hash retrieval</name>
  <files>src/vcs/sapling.rs</files>
  <action>
After successful `sl commit`, run `sl log -l 1 --template '{node|short}'` to get hash.
Sapling's commit command produces no stdout on success.
  </action>
  <verify>cargo build && cargo test</verify>
  <done>
Sapling commit returns actual hash from sl log after successful commit.
  </done>
</task>

</tasks>

<success_criteria>
- src/build/state.rs has project_name field
- src/build/iteration.rs uses ctx.project_name for commit message
- src/vcs/sapling.rs retrieves hash via sl log after commit
- All tests pass
- Both UAT gaps resolved
</success_criteria>
