---
phase: 05-vcs-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/build/iteration.rs
  - src/vcs/sapling.rs
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Commit message includes correct project name from original progress file"
    - "Sapling commit returns actual commit hash, not 'unknown'"
  artifacts:
    - path: src/build/iteration.rs
      provides: "Iteration commit with correct project name"
      contains: "ctx.progress.name"
    - path: src/vcs/sapling.rs
      provides: "Sapling commit hash retrieval via sl log"
      contains: "sl log"
  key_links:
    - from: src/build/iteration.rs
      to: ctx.progress.name
      via: "format_iteration_commit call"
      pattern: "format_iteration_commit\\(&ctx\\.progress\\.name"
    - from: src/vcs/sapling.rs
      to: "sl log command"
      via: "post-commit hash lookup"
      pattern: "sl.*log.*-l.*1"
---

<objective>
Fix two UAT-diagnosed bugs in VCS integration: empty project name in commit messages and "unknown" hash for Sapling commits.

Purpose: Address gaps identified in 05-UAT.md that prevent VCS integration from working correctly.
Output: Both bugs fixed, VCS commit messages and hash logging work as expected.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-vcs-integration/05-01-SUMMARY.md
@.planning/phases/05-vcs-integration/05-UAT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix project name in commit message</name>
  <files>src/build/iteration.rs</files>
  <action>
On line 200 of src/build/iteration.rs, the format_iteration_commit call uses `updated_progress.name` which comes from Claude's response. Claude may return an empty or modified project name.

Change:
```rust
format_iteration_commit(&updated_progress.name, ctx.current_iteration, tasks_completed);
```

To:
```rust
format_iteration_commit(&ctx.progress.name, ctx.current_iteration, tasks_completed);
```

The `ctx.progress` contains the ORIGINAL progress file that was loaded at the start of iteration. It has the correct project name. The `updated_progress` is parsed from Claude's response and may have an empty name if Claude doesn't output it correctly.

Note: ctx.progress is updated AFTER the VCS commit (line 217), so at line 200 it still holds the original values.
  </action>
  <verify>
Run `cargo build` to ensure compilation succeeds.
Run `cargo test --lib build::iteration` to ensure iteration tests pass.
  </verify>
  <done>
Commit message uses ctx.progress.name (original file) instead of updated_progress.name (Claude response).
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix Sapling commit hash retrieval</name>
  <files>src/vcs/sapling.rs</files>
  <action>
The Sapling `sl commit` command produces no stdout on success. The current code assumes the hash is in stdout and falls back to "unknown" when parsing fails.

Fix the `commit` method in SaplingVcs:

1. After a successful `sl commit`, run `sl log -l 1 --template '{node|short}'` to get the commit hash
2. Return the hash from sl log, not from sl commit stdout

Updated commit method:
```rust
fn commit(&self, message: &str) -> Result<String, VcsError> {
    let output = self.run_sl(&["commit", "-m", message])?;
    if !output.status.success() {
        let stderr = String::from_utf8_lossy(&output.stderr);
        let stdout = String::from_utf8_lossy(&output.stdout);
        // Check for "nothing changed" case
        if stdout.contains("nothing changed") || stderr.contains("nothing changed") {
            return Err(VcsError::NothingToCommit);
        }
        return Err(VcsError::CommitFailed(stderr.to_string()));
    }

    // sl commit produces no stdout on success
    // Get the commit hash from sl log
    let log_output = self.run_sl(&["log", "-l", "1", "--template", "{node|short}"])?;
    if !log_output.status.success() {
        // Fall back to unknown if log fails (commit still succeeded)
        return Ok("unknown".to_string());
    }

    let hash = String::from_utf8_lossy(&log_output.stdout)
        .trim()
        .to_string();

    if hash.is_empty() {
        Ok("unknown".to_string())
    } else {
        Ok(hash)
    }
}
```
  </action>
  <verify>
Run `cargo build` to ensure compilation succeeds.
Run `cargo test --lib vcs` to ensure VCS tests pass.
  </verify>
  <done>
Sapling commit returns actual hash from `sl log -l 1 --template '{node|short}'` after successful commit.
  </done>
</task>

</tasks>

<verification>
After both tasks:
1. `cargo build` completes without errors
2. `cargo test` passes all tests
3. Manual test (if in Sapling repo): Run a build that completes a task and verify:
   - Commit message shows `[ProjectName][iter N] Completed M task(s)` with correct project name
   - Log shows `[VCS] Committed: <actual-hash> (Sapling)` with real hash, not "unknown"
</verification>

<success_criteria>
- src/build/iteration.rs uses ctx.progress.name for commit message
- src/vcs/sapling.rs retrieves hash via sl log after commit
- All tests pass
- Both UAT gaps from 05-UAT.md are resolved
</success_criteria>

<output>
After completion, create `.planning/phases/05-vcs-integration/05-02-SUMMARY.md`
</output>
