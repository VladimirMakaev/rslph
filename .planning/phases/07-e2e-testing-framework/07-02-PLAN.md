---
phase: 07-e2e-testing-framework
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/e2e/conftest.py
  - tests/e2e/__init__.py
  - tests/e2e/test_smoke.py
  - .gitignore
autonomous: true

must_haves:
  truths:
    - "Pytest discovers and runs tests in tests/e2e/"
    - "workspace fixture creates isolated temp directory with git init"
    - "workspace fixture creates minimal valid rslph config"
    - "rslph_binary fixture builds and returns path to release binary"
    - "Failed test directories are preserved for debugging"
  artifacts:
    - path: "tests/e2e/conftest.py"
      provides: "Pytest fixtures: workspace, rslph_binary"
      min_lines: 60
    - path: "tests/e2e/__init__.py"
      provides: "Package marker"
    - path: "tests/e2e/test_smoke.py"
      provides: "Smoke test validating fixture setup"
      min_lines: 20
  key_links:
    - from: "tests/e2e/conftest.py"
      to: "pyproject.toml"
      via: "pytest discovers fixtures per pyproject.toml testpaths"
      pattern: "testpaths.*e2e"
    - from: "tests/e2e/conftest.py"
      to: "target/release/rslph"
      via: "rslph_binary fixture runs cargo build"
      pattern: "cargo.*build"
---

<objective>
Create pytest infrastructure with workspace fixtures for isolated E2E testing of rslph.

Purpose: Provide reusable test fixtures that create isolated workspaces with git, config files, and access to the rslph binary.

Output: tests/e2e/ directory with conftest.py fixtures and smoke test.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-e2e-testing-framework/07-CONTEXT.md
@.planning/phases/07-e2e-testing-framework/07-RESEARCH.md

# Reference for config format
@src/config.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tests/e2e structure with conftest.py fixtures</name>
  <files>
    tests/e2e/__init__.py
    tests/e2e/conftest.py
  </files>
  <action>
1. Create `tests/e2e/__init__.py` as empty package marker.

2. Create `tests/e2e/conftest.py` with fixtures per RESEARCH.md patterns:

```python
import pytest
from pathlib import Path
import subprocess
import os

@pytest.fixture(scope="session")
def rslph_binary():
    """Build and return path to rslph release binary."""
    project_root = Path(__file__).parent.parent.parent
    result = subprocess.run(
        ["cargo", "build", "--release"],
        cwd=project_root,
        capture_output=True
    )
    assert result.returncode == 0, f"Build failed: {result.stderr.decode()}"
    return project_root / "target" / "release" / "rslph"

@pytest.fixture
def workspace(tmp_path):
    """Create isolated workspace with git and minimal config."""
    class Workspace:
        def __init__(self, path: Path):
            self.path = path
            self._setup_git()
            self._setup_config()

        def _setup_git(self):
            subprocess.run(["git", "init"], cwd=self.path, capture_output=True, check=True)
            subprocess.run(["git", "config", "user.email", "test@test.com"],
                          cwd=self.path, capture_output=True, check=True)
            subprocess.run(["git", "config", "user.name", "Test"],
                          cwd=self.path, capture_output=True, check=True)

        def _setup_config(self):
            config_dir = self.path / ".rslph"
            config_dir.mkdir(parents=True, exist_ok=True)
            config_file = config_dir / "config.toml"
            config_file.write_text('[rslph]\nclaude_path = "claude"\n')

        def write_file(self, rel_path: str, content: str) -> Path:
            """Write a file relative to workspace root."""
            path = self.path / rel_path
            path.parent.mkdir(parents=True, exist_ok=True)
            path.write_text(content)
            return path

        def read_file(self, rel_path: str) -> str:
            """Read a file relative to workspace root."""
            return (self.path / rel_path).read_text()

        def file_exists(self, rel_path: str) -> bool:
            """Check if file exists."""
            return (self.path / rel_path).exists()

        def write_progress(self, content: str) -> Path:
            """Write PROGRESS.md file."""
            return self.write_file("PROGRESS.md", content)

        def with_claude_path(self, claude_path: str) -> "Workspace":
            """Update config to use specific claude executable."""
            config_file = self.path / ".rslph" / "config.toml"
            config_file.write_text(f'[rslph]\nclaude_path = "{claude_path}"\n')
            return self

        def commit_all(self, message: str = "test commit"):
            """Stage all files and commit."""
            subprocess.run(["git", "add", "-A"], cwd=self.path, capture_output=True, check=True)
            subprocess.run(["git", "commit", "-m", message, "--allow-empty"],
                          cwd=self.path, capture_output=True, check=True)

    return Workspace(tmp_path)
```

Note: Per CONTEXT.md, workspace uses per-test isolation (tmp_path creates fresh dir per test).
  </action>
  <verify>
```bash
cd /Users/vmakaev/NonWork/rslph
python3 -c "
import sys
sys.path.insert(0, 'tests/e2e')
from conftest import *
print('Imports OK')
"
```
  </verify>
  <done>tests/e2e/conftest.py exists with workspace and rslph_binary fixtures</done>
</task>

<task type="auto">
  <name>Task 2: Create smoke test and update .gitignore</name>
  <files>
    tests/e2e/test_smoke.py
    .gitignore
  </files>
  <action>
1. Create `tests/e2e/test_smoke.py` - smoke tests validating fixtures work:

```python
"""Smoke tests to validate E2E test infrastructure."""
import subprocess

def test_workspace_creates_git_repo(workspace):
    """Workspace fixture creates valid git repository."""
    git_dir = workspace.path / ".git"
    assert git_dir.exists(), "Git not initialized"
    assert git_dir.is_dir(), "Git dir is not a directory"

def test_workspace_has_config(workspace):
    """Workspace fixture creates rslph config."""
    config = workspace.path / ".rslph" / "config.toml"
    assert config.exists(), "Config not created"
    assert "claude_path" in config.read_text()

def test_workspace_write_read_file(workspace):
    """Can write and read files in workspace."""
    workspace.write_file("test.txt", "hello world")
    assert workspace.read_file("test.txt") == "hello world"

def test_workspace_write_progress(workspace):
    """Can write PROGRESS.md."""
    workspace.write_progress("# Tasks\n- [ ] Task 1")
    assert workspace.file_exists("PROGRESS.md")
    assert "Task 1" in workspace.read_file("PROGRESS.md")

def test_workspace_with_claude_path(workspace):
    """Can update claude_path in config."""
    workspace.with_claude_path("/custom/path/to/fake")
    config_content = (workspace.path / ".rslph" / "config.toml").read_text()
    assert "/custom/path/to/fake" in config_content

def test_workspace_commit(workspace):
    """Can commit files to git."""
    workspace.write_file("test.txt", "content")
    workspace.commit_all("Initial commit")
    result = subprocess.run(
        ["git", "log", "--oneline"],
        cwd=workspace.path,
        capture_output=True,
        text=True
    )
    assert "Initial commit" in result.stdout

def test_rslph_binary_exists(rslph_binary):
    """rslph binary is built and exists."""
    assert rslph_binary.exists(), f"Binary not found at {rslph_binary}"

def test_rslph_binary_runs(rslph_binary):
    """rslph binary can execute --help."""
    result = subprocess.run(
        [str(rslph_binary), "--help"],
        capture_output=True,
        text=True
    )
    assert result.returncode == 0
    assert "rslph" in result.stdout.lower() or "ralph" in result.stdout.lower()
```

2. Update `.gitignore` to add Python/pytest entries:

Read current .gitignore and append:
```
# Python
__pycache__/
*.py[cod]
*$py.class
*.so
.Python
*.egg-info/
.eggs/
dist/
build/
*.egg

# pytest
.pytest_cache/
.coverage
htmlcov/

# Virtual environments
venv/
.venv/
ENV/
```
  </action>
  <verify>
```bash
cd /Users/vmakaev/NonWork/rslph
# Run pytest smoke tests
python3 -m pytest tests/e2e/test_smoke.py -v --tb=short
```
  </verify>
  <done>Smoke tests pass, .gitignore updated for Python artifacts</done>
</task>

</tasks>

<verification>
```bash
cd /Users/vmakaev/NonWork/rslph

# Verify directory structure
ls -la tests/e2e/

# Run all smoke tests
python3 -m pytest tests/e2e/ -v

# Verify .gitignore has Python entries
grep -q "__pycache__" .gitignore && echo ".gitignore OK"
```
</verification>

<success_criteria>
1. tests/e2e/ directory exists with __init__.py, conftest.py, test_smoke.py
2. `workspace` fixture creates isolated temp directory with git and config
3. `rslph_binary` fixture builds and returns binary path
4. All smoke tests pass: `python3 -m pytest tests/e2e/ -v`
5. .gitignore updated with Python/pytest entries
</success_criteria>

<output>
After completion, create `.planning/phases/07-e2e-testing-framework/07-02-SUMMARY.md`
</output>
