---
phase: 07.1-tui-testing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/e2e/main.rs
  - tests/e2e/tui_tests.rs
  - tests/e2e/snapshots/tui_tests__initial_render.snap
  - tests/e2e/snapshots/tui_tests__with_messages.snap
  - tests/e2e/snapshots/tui_tests__paused_state.snap
  - tests/e2e/snapshots/tui_tests__scroll_navigation.snap
  - tests/e2e/snapshots/tui_tests__iteration_navigation.snap
autonomous: true

must_haves:
  truths:
    - "TUI renders correctly in test environment"
    - "Snapshots capture initial screen state"
    - "Snapshots capture screen with messages"
    - "Key presses produce expected visual changes"
    - "TUI tests run with cargo test"
  artifacts:
    - path: "tests/e2e/tui_tests.rs"
      provides: "TUI snapshot and input tests"
      min_lines: 100
    - path: "tests/e2e/snapshots/tui_tests__initial_render.snap"
      provides: "Baseline snapshot for empty TUI"
      contains: "snapshot"
    - path: "tests/e2e/snapshots/tui_tests__with_messages.snap"
      provides: "Snapshot for TUI with Claude output"
      contains: "snapshot"
  key_links:
    - from: "tests/e2e/main.rs"
      to: "tests/e2e/tui_tests.rs"
      via: "mod tui_tests declaration"
      pattern: "mod tui_tests"
    - from: "tests/e2e/tui_tests.rs"
      to: "src/tui/app.rs"
      via: "App and AppEvent imports"
      pattern: "use rslph::tui"
    - from: "tests/e2e/tui_tests.rs"
      to: "src/tui/ui.rs"
      via: "render function import"
      pattern: "use rslph::tui::ui::render"
---

<objective>
Create TUI snapshot tests using TestBackend and insta to verify rendering and key handling.

Purpose: Establish regression testing for TUI visual output, ensuring UI changes are intentional and caught by snapshot diffs.

Output: TUI test module with rendering snapshots and key handling verification.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07.1-tui-testing-ratatui-testlib/07.1-RESEARCH.md
@.planning/phases/07.1-tui-testing-ratatui-testlib/CONTEXT.md

# Key source files
@src/tui/app.rs
@src/tui/ui.rs
@src/tui/keybindings.rs
@tests/e2e/main.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TUI rendering snapshot tests</name>
  <files>
    tests/e2e/main.rs
    tests/e2e/tui_tests.rs
    tests/e2e/snapshots/tui_tests__initial_render.snap
    tests/e2e/snapshots/tui_tests__with_messages.snap
    tests/e2e/snapshots/tui_tests__paused_state.snap
  </files>
  <action>
    1. Add `mod tui_tests;` to tests/e2e/main.rs after existing module declarations

    2. Create tests/e2e/tui_tests.rs with:
       - Imports: ratatui (TestBackend, Terminal), insta (assert_snapshot!), rslph::tui::{app::{App, AppEvent, MessageRole, Message}, ui::render}
       - Helper function to create test terminal: `fn test_terminal() -> Terminal<TestBackend>` with 80x24 dimensions
       - Helper function to create app with test data: `fn app_with_messages() -> App` that sets up realistic state

    3. Implement snapshot tests:
       a. test_initial_render: Create App::new(5, "claude-sonnet-4", "test-project"), render to TestBackend, assert_snapshot!
       b. test_with_messages: Use AppEvent::IterationStart, AppEvent::ClaudeOutput, AppEvent::ToolMessage to populate state, render and snapshot
       c. test_paused_state: Set app.is_paused = true, render and snapshot (should show pause overlay)

    4. Run tests with `cargo test tui_tests` - first run will create snapshot files
    5. Review snapshots with `cargo insta review` or accept with `cargo insta accept`

    IMPORTANT:
    - Use fixed 80x24 terminal size for reproducibility
    - TestBackend implements Display - pass terminal.backend() directly to assert_snapshot!
    - Snapshots are text-only (no color info) - this is expected per research findings
    - Use `insta::Settings::set_snapshot_path` if snapshots don't go to tests/e2e/snapshots/ by default
  </action>
  <verify>
    - `cargo test tui_tests -- --nocapture` runs without errors
    - Snapshot files exist in tests/e2e/snapshots/
    - Snapshots contain readable ASCII representation of TUI layout
  </verify>
  <done>
    - tests/e2e/tui_tests.rs exists with 3+ rendering tests
    - Snapshot files created and accepted
    - Tests pass on subsequent runs (snapshots match)
  </done>
</task>

<task type="auto">
  <name>Task 2: Add key handling tests with snapshot verification</name>
  <files>
    tests/e2e/tui_tests.rs
    tests/e2e/snapshots/tui_tests__scroll_navigation.snap
    tests/e2e/snapshots/tui_tests__iteration_navigation.snap
  </files>
  <action>
    1. Add key handling tests to tests/e2e/tui_tests.rs:

    a. test_scroll_navigation:
       - Create app with messages that exceed viewport
       - Add several ClaudeOutput messages to create scrollable content
       - Apply AppEvent::ScrollDown, render, snapshot
       - Verify scroll_offset changed

    b. test_iteration_navigation:
       - Create app with multiple iterations (use AppEvent::IterationStart multiple times)
       - Add messages to iteration 1 and 2
       - Apply AppEvent::PrevIteration, render, snapshot showing iteration 1 content
       - Verify viewing_iteration changed

    c. test_quit_key:
       - Create app, apply AppEvent::Quit
       - Assert app.should_quit is true (no snapshot needed - state check)

    d. test_toggle_pause:
       - Create app, apply AppEvent::TogglePause
       - Render, snapshot (should show PAUSED overlay)
       - Apply AppEvent::TogglePause again, render
       - Verify is_paused toggled back

    2. Import handle_event from rslph::tui::keybindings if needed for more realistic key handling tests

    IMPORTANT:
    - Use AppEvent directly (not raw KeyEvent) per research recommendation
    - Each test creates fresh App to avoid state leakage
    - Snapshot after visual-changing events, assert state after non-visual events
  </action>
  <verify>
    - `cargo test tui_tests -- --nocapture` passes all tests
    - New snapshots exist for scroll and iteration navigation
    - State assertions pass (should_quit, is_paused, viewing_iteration)
  </verify>
  <done>
    - Key handling tests cover: scroll, iteration navigation, quit, pause toggle
    - Snapshots verify visual changes from key presses
    - All TUI tests pass with `cargo test`
  </done>
</task>

</tasks>

<verification>
Run complete E2E test suite to ensure TUI tests integrate properly:

```bash
cargo test --test e2e
```

Verify TUI tests specifically:

```bash
cargo test tui_tests -- --nocapture
```

Review all snapshots are sensible:

```bash
cargo insta test --review
```
</verification>

<success_criteria>
- [ ] tests/e2e/tui_tests.rs exists with rendering and key handling tests
- [ ] Module registered in tests/e2e/main.rs
- [ ] Snapshots in tests/e2e/snapshots/ match expected TUI output
- [ ] All TUI tests pass with `cargo test`
- [ ] Snapshots capture: initial render, with messages, paused state, scroll, iteration navigation
- [ ] Key handling tests verify: scroll, iteration nav, quit, pause toggle
</success_criteria>

<output>
After completion, create `.planning/phases/07.1-tui-testing-ratatui-testlib/07.1-01-SUMMARY.md`
</output>
