---
phase: 08-token-tracking
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/tui/app.rs
  - tests/e2e/tui_tests.rs
  - tests/e2e/snapshots/e2e__tui_tests__token_accumulation_across_iterations.snap
  - tests/e2e/snapshots/e2e__tui_tests__status_bar_large_tokens.snap
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Token counts accumulate (+=) rather than overwrite (=) in TUI status bar"
    - "Multi-iteration builds show running total, not per-iteration values"
    - "Human-readable formatting with k/M suffixes has TUI snapshot test coverage"
  artifacts:
    - path: "src/tui/app.rs"
      provides: "Fixed token accumulation using += operator"
      contains: "+="
      lines: "439-442"
    - path: "tests/e2e/tui_tests.rs"
      provides: "TUI snapshot test for cumulative token accumulation"
      contains: "test_token_accumulation_across_iterations"
    - path: "tests/e2e/snapshots/e2e__tui_tests__token_accumulation_across_iterations.snap"
      provides: "Snapshot showing cumulative totals (iter1 + iter2 tokens)"
  key_links:
    - from: "AppEvent::TokenUsage handler"
      to: "self.total_tokens fields"
      via: "+= operator for accumulation"
      pattern: "self\\.total_tokens\\..*\\+="
---

<objective>
Fix token accumulation bug and add TUI snapshot tests for user-reported issues.

Purpose: Close 3 UAT gaps from Phase 8 token tracking (tests 1, 3, 4)
Output: Bug fix in app.rs, updated/new TUI snapshot tests confirming correct behavior
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-token-tracking/08-UAT.md
@.planning/phases/08-token-tracking/08-03-SUMMARY.md
@src/tui/app.rs
@tests/e2e/tui_tests.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix token accumulation bug in app.rs</name>
  <files>src/tui/app.rs</files>
  <action>
Change the AppEvent::TokenUsage handler at lines 439-442 from assignment (=) to accumulation (+=):

Before:
```rust
self.total_tokens.input_tokens = input_tokens;
self.total_tokens.output_tokens = output_tokens;
self.total_tokens.cache_creation_input_tokens = cache_creation_input_tokens;
self.total_tokens.cache_read_input_tokens = cache_read_input_tokens;
```

After:
```rust
self.total_tokens.input_tokens += input_tokens;
self.total_tokens.output_tokens += output_tokens;
self.total_tokens.cache_creation_input_tokens += cache_creation_input_tokens;
self.total_tokens.cache_read_input_tokens += cache_read_input_tokens;
```

Update the comment above the handler to clarify the accumulation behavior:
"Token events contain per-message values; we accumulate across all messages and iterations"
  </action>
  <verify>
Run `cargo build` - compiles without errors.
Run `cargo test` - existing tests pass (some snapshots may need updating due to changed behavior).
  </verify>
  <done>
AppEvent::TokenUsage handler uses += for all 4 token fields.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update and add TUI snapshot tests for token accumulation</name>
  <files>tests/e2e/tui_tests.rs, tests/e2e/snapshots/e2e__tui_tests__token_accumulation_across_iterations.snap</files>
  <action>
1. **Replace `test_token_values_across_iterations`** with `test_token_accumulation_across_iterations`:

The existing test sends two TokenUsage events but only checks the final snapshot. With the fix, tokens now accumulate. Rename and update the test to explicitly verify cumulative behavior:

```rust
/// Test that token values ACCUMULATE correctly across iterations.
///
/// This verifies the += accumulation behavior (not = overwrite).
/// Iteration 1: 1000 in, 500 out
/// Iteration 2: +2500 in, +1300 out (additional)
/// Expected total: 3500 in, 1800 out, 500 cacheW, 1200 cacheR
#[test]
fn test_token_accumulation_across_iterations() {
    let mut terminal = test_terminal();
    let mut app = App::new(10, "claude-opus-4-5", "test-project");

    // First iteration with some tokens
    app.update(AppEvent::IterationStart { iteration: 1 });
    app.update(AppEvent::TokenUsage {
        input_tokens: 1000,
        output_tokens: 500,
        cache_creation_input_tokens: 0,
        cache_read_input_tokens: 0,
    });
    app.update(AppEvent::IterationComplete { tasks_done: 1 });

    // Second iteration with MORE tokens (these ADD to iteration 1)
    app.update(AppEvent::IterationStart { iteration: 2 });
    app.update(AppEvent::TokenUsage {
        input_tokens: 2500,  // Total now: 1000 + 2500 = 3500
        output_tokens: 1300, // Total now: 500 + 1300 = 1800
        cache_creation_input_tokens: 500,
        cache_read_input_tokens: 1200,
    });

    terminal
        .draw(|frame| render(frame, &app, 10))
        .unwrap();

    // Snapshot should show CUMULATIVE values: 3.5k in, 1.8k out
    assert_snapshot!(terminal.backend());
}
```

2. **Update `test_status_bar_large_tokens`** snapshot if needed:

After running tests, update the snapshot if the values changed. The test itself is fine; just accept the new snapshot showing the correct accumulated values.

3. **Run `cargo insta test --accept`** to update all affected snapshots with the new accumulated values.
  </action>
  <verify>
Run `cargo test test_token_accumulation_across_iterations` - passes.
Run `cargo test tui_tests` - all TUI tests pass.
Check snapshot file contains cumulative values (3.5k, 1.8k in the example).
  </verify>
  <done>
- `test_token_values_across_iterations` renamed to `test_token_accumulation_across_iterations`
- Test explicitly documents cumulative behavior in comments
- Snapshot shows accumulated token totals, not per-iteration values
- Existing large token snapshot (`test_status_bar_large_tokens`) verified
  </done>
</task>

</tasks>

<verification>
After both tasks:

```bash
# Full test suite
cargo test

# Specific token-related TUI tests
cargo test tui_tests::test_token_accumulation
cargo test tui_tests::test_status_bar_large_tokens
cargo test tui_tests::test_status_bar_displays_tokens

# Verify snapshot contents show cumulative values
grep -A5 "In:" tests/e2e/snapshots/e2e__tui_tests__token_accumulation_across_iterations.snap
```

Expected: Snapshot shows "In: 3.5k" (1000 + 2500), not "In: 2.5k" (overwritten).
</verification>

<success_criteria>
1. `src/tui/app.rs` uses `+=` for all 4 token fields in AppEvent::TokenUsage handler
2. `test_token_accumulation_across_iterations` exists and passes
3. Snapshot shows cumulative token values (iter1 + iter2)
4. All existing TUI tests pass (snapshots updated as needed)
5. `cargo test` passes with no failures
</success_criteria>

<output>
After completion, create `.planning/phases/08-token-tracking/08-04-SUMMARY.md`
</output>
