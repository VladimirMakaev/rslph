---
phase: 11-prompt-engineering
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - prompts/gsd_tdd/PROMPT_plan.md
  - prompts/gsd_tdd/PROMPT_build.md
autonomous: true

must_haves:
  truths:
    - "GSD-TDD plan prompt includes test-first task ordering"
    - "GSD-TDD build prompt enforces RED-GREEN-REFACTOR cycle"
    - "TDD escape hatch exists after 3 consecutive failures"
    - "Progress file tracks TDD phase and attempt count"
  artifacts:
    - path: "prompts/gsd_tdd/PROMPT_plan.md"
      provides: "TDD-focused planning prompt"
      min_lines: 120
    - path: "prompts/gsd_tdd/PROMPT_build.md"
      provides: "TDD-enforcing build prompt"
      min_lines: 180
  key_links:
    - from: "prompts/gsd_tdd/PROMPT_plan.md"
      to: "prompts/gsd_tdd/PROMPT_build.md"
      via: "TDD state in progress frontmatter"
      pattern: "tdd_phase:"
---

<objective>
Create GSD-TDD mode prompts with strict test-driven development flow.

Purpose: Implement PROMPT-03 (TDD iteration flow) building on GSD foundation.
Output: prompts/gsd_tdd/PROMPT_plan.md and prompts/gsd_tdd/PROMPT_build.md
</objective>

<context>
@.planning/PROJECT.md
@.planning/phases/11-prompt-engineering/CONTEXT.md
@.planning/phases/11-prompt-engineering/11-RESEARCH.md

# Current prompts for reference
@prompts/PROMPT_plan.md
@prompts/PROMPT_build.md

# GSD TDD patterns from CONTEXT.md:
# - Strict test-first
# - RED-GREEN-REFACTOR cycle
# - Escape hatch after 3 failures
# - TDD state tracking in frontmatter
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GSD-TDD planning prompt</name>
  <files>prompts/gsd_tdd/PROMPT_plan.md</files>
  <action>
Create `prompts/gsd_tdd/` directory and `PROMPT_plan.md` with TDD-focused planning.

This prompt extends GSD patterns with TDD task ordering:

1. **TDD Task Pairing** - Every implementation has paired test task:
```markdown
## TDD Task Structure

For each feature, create paired tasks:

<task type="test">
  <name>Write failing test for [feature]</name>
  <action>Create test that describes expected behavior</action>
  <verify>Run tests - this test MUST fail (RED phase)</verify>
  <done>Test exists, runs, and fails with expected reason</done>
</task>

<task type="implement">
  <name>Implement [feature] to pass test</name>
  <action>Write minimal code to make test pass</action>
  <verify>Run tests - all tests MUST pass (GREEN phase)</verify>
  <done>Test passes, implementation is minimal</done>
</task>

<task type="refactor">
  <name>Refactor [feature] (optional)</name>
  <action>Clean up implementation if needed</action>
  <verify>Run tests - still pass after refactor</verify>
  <done>Code is clean, tests still pass</done>
</task>
```

2. **TDD Progress Frontmatter**:
```yaml
---
phase: 1
status: in_progress
tdd_mode: true
tdd_state:
  current_feature: null
  phase: red  # red | green | refactor
  consecutive_failures: 0
  escaped: false
  escape_reason: null
---
```

3. **Test-First Task Ordering**:
- Never have implementation task before its test task
- Group by feature: test -> implement -> (optional refactor)
- Testing infrastructure always in Phase 1

Include all GSD patterns (XML structure, must-haves) plus TDD-specific ordering.
  </action>
  <verify>File exists at prompts/gsd_tdd/PROMPT_plan.md with TDD task pairing structure</verify>
  <done>TDD plan prompt enforces test-first task ordering with paired test/implement tasks</done>
</task>

<task type="auto">
  <name>Task 2: Create GSD-TDD build prompt with TDD enforcement</name>
  <files>prompts/gsd_tdd/PROMPT_build.md</files>
  <action>
Create `prompts/gsd_tdd/PROMPT_build.md` with TDD cycle enforcement.

Key elements (PROMPT-03):

1. **TDD Phase Enforcement**:
```markdown
## TDD Execution Rules

<critical>
You MUST follow the RED-GREEN-REFACTOR cycle strictly.
</critical>

### RED Phase (Writing Failing Test)
When task type is "test":
1. Write the test first
2. Run the test
3. Verify it FAILS (if it passes, the test is wrong or feature exists)
4. Update tdd_state.phase to "red" in frontmatter
5. Mark task complete only if test fails as expected

### GREEN Phase (Making Test Pass)
When task type is "implement":
1. Check that previous test task is complete and failing
2. Write MINIMAL code to make test pass
3. No extra features, no optimization
4. Update tdd_state.phase to "green"
5. Mark complete only when test passes

### REFACTOR Phase (Optional Cleanup)
When task type is "refactor":
1. Only if code needs cleanup
2. Make changes
3. Run tests - must still pass
4. Update tdd_state.phase to "refactor"
5. If no refactoring needed, mark complete with note
```

2. **TDD Escape Hatch**:
```markdown
## TDD Escape Hatch

If stuck in TDD cycle for 3 consecutive iterations on same feature:

<escape_conditions>
- 3 failures on same test task (can't write valid failing test)
- 3 failures on same implement task (can't make test pass)
- Test is fundamentally untestable (UI, timing, external service)
</escape_conditions>

<escape_procedure>
1. Set tdd_state.escaped = true
2. Set tdd_state.escape_reason = "[reason]"
3. Document in Recent Attempts
4. Proceed with implementation without test
5. Add manual verification in Completed This Iteration
</escape_procedure>

After escaping:
- Continue with remaining tasks normally
- TDD escapes are reported at build completion
- User is notified which features skipped TDD
```

3. **TDD State Updates**:
```markdown
## Progress File Updates

After each iteration, update the tdd_state in frontmatter:

```yaml
tdd_state:
  current_feature: "user login"
  phase: green
  consecutive_failures: 0
  escaped: false
  escape_reason: null
```

If task fails:
- Increment consecutive_failures
- Keep same phase
- Document what went wrong in Recent Attempts
```

Include all GSD patterns (deviation handling, completion summary, must-haves) plus TDD enforcement.
  </action>
  <verify>File exists with TDD phase enforcement, escape hatch rules, and state tracking</verify>
  <done>TDD build prompt enforces RED-GREEN-REFACTOR with escape hatch after 3 failures</done>
</task>

</tasks>

<verification>
- prompts/gsd_tdd/PROMPT_plan.md exists with:
  - TDD task pairing (test -> implement -> refactor)
  - TDD frontmatter structure (tdd_state)
  - Test-first ordering enforcement
- prompts/gsd_tdd/PROMPT_build.md exists with:
  - RED-GREEN-REFACTOR cycle rules
  - Escape hatch after 3 consecutive failures
  - TDD state update instructions
- Both prompts inherit GSD patterns (deviation handling, summaries, must-haves)
</verification>

<success_criteria>
- [ ] prompts/gsd_tdd/PROMPT_plan.md created with TDD task structure
- [ ] TDD plan enforces test-before-implementation ordering
- [ ] prompts/gsd_tdd/PROMPT_build.md includes TDD cycle enforcement
- [ ] Escape hatch documented with 3-failure threshold (PROMPT-03)
- [ ] Progress file tracks TDD phase and consecutive failures
</success_criteria>

<output>
After completion, create `.planning/phases/11-prompt-engineering/11-03-SUMMARY.md`
</output>
