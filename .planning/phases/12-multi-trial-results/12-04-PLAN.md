---
phase: 12-multi-trial-results
plan: 04
type: execute
wave: 4
depends_on: ["12-03"]
files_modified:
  - src/cli.rs
  - src/eval/command.rs
  - src/eval/mod.rs
  - src/main.rs
autonomous: true

must_haves:
  truths:
    - "User can compare two result files with rslph compare"
    - "Comparison shows delta for pass rate, tokens, execution time"
    - "Positive deltas show improvement (^), negative show regression (v)"
    - "Comparison gracefully handles missing or invalid files"
  artifacts:
    - path: "src/cli.rs"
      provides: "Compare command in CLI"
      contains: "Commands::Compare"
    - path: "src/eval/command.rs"
      provides: "run_compare_command function"
      exports: ["run_compare_command"]
    - path: "src/main.rs"
      provides: "Compare command handling"
      contains: "Commands::Compare"
  key_links:
    - from: "src/main.rs"
      to: "run_compare_command"
      via: "match arm"
      pattern: "Commands::Compare.*run_compare_command"
    - from: "src/eval/command.rs"
      to: "load_multi_trial_result"
      via: "file loading"
      pattern: "load_multi_trial_result"
---

<objective>
Add Compare command to compare two eval result files (EVAL-09)

Purpose: Enable users to compare results between different runs to measure improvement
Output: Top-level Compare command that loads two JSON files and displays deltas
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-multi-trial-results/12-RESEARCH.md

# Prior plan artifacts - need 12-03 for SerializableMultiTrialResult
@.planning/phases/12-multi-trial-results/12-03-SUMMARY.md

# Current implementation
@src/cli.rs
@src/eval/command.rs
@src/eval/mod.rs
@src/main.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Compare command to CLI</name>
  <files>src/cli.rs</files>
  <action>
Add Compare command variant to the Commands enum:

```rust
/// Compare two eval result files
Compare {
    /// First result file (baseline)
    file1: PathBuf,

    /// Second result file (comparison)
    file2: PathBuf,
},
```

Add CLI tests:
- `test_parse_compare_command`: Verify `rslph compare file1.json file2.json` parses correctly
- Verify both file paths are captured
  </action>
  <verify>`cargo test --lib test_parse_compare` passes</verify>
  <done>Compare command added to CLI with two PathBuf arguments</done>
</task>

<task type="auto">
  <name>Task 2: Implement load_multi_trial_result function</name>
  <files>src/eval/command.rs</files>
  <action>
Add function to load multi-trial result JSON files:

```rust
/// Load a multi-trial result from JSON file.
fn load_multi_trial_result(path: &Path) -> color_eyre::Result<SerializableMultiTrialResult> {
    let content = std::fs::read_to_string(path)
        .map_err(|e| eyre!("Failed to read {}: {}", path.display(), e))?;

    let result: SerializableMultiTrialResult = serde_json::from_str(&content)
        .map_err(|e| eyre!("Invalid JSON in {}: {}", path.display(), e))?;

    Ok(result)
}
```

Add unit tests:
- `test_load_multi_trial_result` - load valid JSON, verify fields
- `test_load_multi_trial_result_missing_file` - verify error message
- `test_load_multi_trial_result_invalid_json` - verify error message

Note: Reuse the SerializableMultiTrialResult struct from Plan 03 (with Deserialize derive).
  </action>
  <verify>`cargo test --lib test_load_multi_trial` passes</verify>
  <done>load_multi_trial_result loads and parses JSON files with helpful error messages</done>
</task>

<task type="auto">
  <name>Task 3: Implement run_compare_command with delta display</name>
  <files>src/eval/command.rs, src/eval/mod.rs, src/main.rs</files>
  <action>
1. Add `run_compare_command` function to `src/eval/command.rs`:
   ```rust
   pub fn run_compare_command(file1: PathBuf, file2: PathBuf) -> color_eyre::Result<()> {
       let result1 = load_multi_trial_result(&file1)?;
       let result2 = load_multi_trial_result(&file2)?;

       println!("Comparing results:");
       println!("  Baseline:   {} ({} trials)", file1.display(), result1.trial_count);
       println!("  Comparison: {} ({} trials)", file2.display(), result2.trial_count);
       println!();

       // Print deltas for each metric
       print_delta("Pass Rate",
           result1.statistics.pass_rate.mean,
           result2.statistics.pass_rate.mean,
           "%");

       print_delta("Execution Time",
           result1.statistics.elapsed_secs.mean,
           result2.statistics.elapsed_secs.mean,
           "s");

       print_delta("Input Tokens",
           result1.statistics.total_input_tokens.mean,
           result2.statistics.total_input_tokens.mean,
           "");

       print_delta("Output Tokens",
           result1.statistics.total_output_tokens.mean,
           result2.statistics.total_output_tokens.mean,
           "");

       Ok(())
   }
   ```

2. Add helper `print_delta(name: &str, baseline: f64, comparison: f64, unit: &str)`:
   - Calculate delta = comparison - baseline
   - Calculate percent change = (delta / baseline) * 100 (if baseline != 0)
   - Use "^" for positive delta (improvement for pass rate), "v" for negative
   - Note: For time/tokens, lower is better, so invert the arrow
   - Format: `{name}: {baseline:.1}{unit} -> {comparison:.1}{unit} ({arrow}{delta:.1}{unit}, {percent:.1}%)`

3. Export `run_compare_command` from `src/eval/mod.rs`

4. Add Compare command handling to `src/main.rs`:
   ```rust
   Commands::Compare { file1, file2 } => {
       match run_compare_command(file1, file2) {
           Ok(()) => {}
           Err(e) => {
               eprintln!("Compare failed: {}", e);
               std::process::exit(1);
           }
       }
   }
   ```
  </action>
  <verify>`cargo build` succeeds, `cargo run -- compare --help` shows usage</verify>
  <done>Compare command shows deltas for pass rate, time, and tokens with directional arrows</done>
</task>

</tasks>

<verification>
- [ ] `cargo test --lib` - all tests pass
- [ ] `cargo run -- compare --help` - shows file1 and file2 arguments
- [ ] Compare command handles missing files gracefully with helpful error
- [ ] Delta arrows correctly indicate improvement/regression
</verification>

<success_criteria>
1. `rslph compare file1.json file2.json` loads both files and shows comparison
2. Pass rate delta shows: `60.0% -> 80.0% (^20.0%, +33.3%)`
3. Execution time delta shows: `120.0s -> 90.0s (v30.0s, -25.0%)` (lower is better)
4. Missing file gives error: `Failed to read /path/to/file.json: No such file`
5. Invalid JSON gives error: `Invalid JSON in /path/to/file.json: ...`
</success_criteria>

<output>
After completion, create `.planning/phases/12-multi-trial-results/12-04-SUMMARY.md`
</output>
