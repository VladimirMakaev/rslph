# Phase 13 Plan 06: Fix Task Description Truncation

## Context

**Gap:** Plan command generates incomplete task descriptions
**Severity:** Major
**UAT Test:** 4
**Root Cause:** `progress.rs` parser only captures first Text event after TaskListMarker

When parsing markdown like `- [ ] Add \`-n\` flag for newline suppression`, pulldown_cmark emits:
1. `TaskListMarker(false)`
2. `Text("Add ")`
3. `Code("-n")`
4. `Text(" flag for newline suppression")`

Current code consumes the marker on the first Text event, losing subsequent chunks.

## Goal

Fix the progress file parser to accumulate all content for task descriptions, including inline code and formatting.

## Tasks

### Task 1: Add task accumulator state

**Files:** `src/progress.rs`

**Changes:**
1. Add new state variable to track task content accumulation:
   ```rust
   let mut task_description = String::new();
   let mut task_is_checked: Option<bool> = None;
   ```

2. Remove the immediate task creation pattern from `current_task_checked`

### Task 2: Accumulate content between TaskListMarker and End(Item)

**Files:** `src/progress.rs`

**Changes in Event::TaskListMarker handler:**
```rust
Event::TaskListMarker(checked) => {
    task_is_checked = Some(checked);
    task_description.clear();
}
```

**Changes in Event::Text handler:**
```rust
Event::Text(text) => {
    if heading_level.is_some() {
        heading_text.push_str(&text);
    } else if task_is_checked.is_some() {
        // Accumulate task description text
        task_description.push_str(&text);
    } else if in_list_item {
        list_item_text.push_str(&text);
    } else if in_table_cell {
        cell_text.push_str(&text);
    } else {
        section_text.push_str(&text);
        section_text.push('\n');
    }
}
```

### Task 3: Handle Code events for inline code in tasks

**Files:** `src/progress.rs`

**Changes - Add new match arm for Code events:**
```rust
Event::Code(code) => {
    if task_is_checked.is_some() {
        // Include inline code in task description
        task_description.push('`');
        task_description.push_str(&code);
        task_description.push('`');
    } else if in_list_item {
        list_item_text.push('`');
        list_item_text.push_str(&code);
        list_item_text.push('`');
    }
}
```

### Task 4: Create task on End(Item) instead of first Text

**Files:** `src/progress.rs`

**Changes in End(TagEnd::Item) handler:**
```rust
Event::End(TagEnd::Item) => {
    in_list_item = false;

    // If we have a task being built, finalize it
    if let Some(checked) = task_is_checked.take() {
        let task = Task {
            description: task_description.trim().to_string(),
            completed: checked,
        };
        if current_h2 == "Tasks" {
            current_phase_tasks.push(task);
        } else if current_h2 == "Completed This Iteration" {
            pf.completed_this_iteration.push(task_description.trim().to_string());
        }
        task_description.clear();
    } else if current_h2 == "Recent Attempts" && !list_item_text.is_empty() {
        // ... existing Recent Attempts handling ...
    } else if !list_item_text.is_empty() {
        // ... existing section text handling ...
    }
    list_item_text.clear();
}
```

### Task 5: Add unit test for inline code in tasks

**Files:** `src/progress.rs` (tests module)

**Changes:**
```rust
#[test]
fn test_parse_task_with_inline_code() {
    let content = r#"# Progress: Test

## Status

In Progress

## Analysis

Test analysis.

## Tasks

### Phase 1: CLI

- [ ] Add `-n` flag for newline suppression
- [ ] Write tests for `--help` output
- [x] Implement `echo` command

## Testing Strategy

Unit tests.

## Completed This Iteration

## Recent Attempts

## Iteration Log

| Iteration | Started | Duration | Tasks Completed | Notes |
|-----------|---------|----------|-----------------|-------|
"#;

    let pf = ProgressFile::parse(content).expect("Should parse");

    assert_eq!(pf.tasks.len(), 1);
    assert_eq!(pf.tasks[0].tasks.len(), 3);
    assert_eq!(pf.tasks[0].tasks[0].description, "Add `-n` flag for newline suppression");
    assert_eq!(pf.tasks[0].tasks[1].description, "Write tests for `--help` output");
    assert_eq!(pf.tasks[0].tasks[2].description, "Implement `echo` command");
    assert!(pf.tasks[0].tasks[2].completed);
}
```

## Verification

1. Existing tests still pass
2. New test for inline code passes
3. Running `rslph plan "build an echo cli"` produces complete task descriptions
4. Phase 3 tasks no longer truncated at first special character

## Commit

```
fix(progress): accumulate full task description including inline code

- Track task content between TaskListMarker and End(Item)
- Handle Code events to preserve inline code formatting
- Create task on item end instead of first text event

Fixes task truncation bug where descriptions like
"Add `-n` flag" were cut to just "Add".

Closes Gap 2 from 13-UAT.md
```
