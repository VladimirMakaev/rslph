# Phase 13 Plan 07: Wire StreamEvent to Conversation View

## Context

**Gap:** Conversation view displays empty (no LLM stream content)
**Severity:** Blocker
**UAT Test:** 5
**Root Cause:** `SubprocessEvent` enum lacks `StreamEvent` variant; wiring incomplete

Current flow:
1. `iteration.rs:parse_and_stream_line` parses `StreamEvent`
2. Extracts text → sends `SubprocessEvent::Output`
3. Extracts tool uses → sends `SubprocessEvent::ToolUse`
4. **Never sends raw `StreamEvent`**

Required flow:
1. Parse `StreamEvent`
2. Send `SubprocessEvent::StreamEvent(event)` for conversation extraction
3. Event loop converts to `AppEvent::StreamEvent`
4. App handler calls `extract_conversation_items()` → populates `ConversationBuffer`

## Goal

Wire raw StreamEvents to the TUI so conversation view displays thinking blocks, tool calls, and text.

## Tasks

### Task 1: Add SubprocessEvent::StreamEvent variant

**Files:** `src/tui/event.rs`

**Changes:**
1. Add import for StreamEvent at top of file
2. Add new variant to SubprocessEvent enum

```rust
use crate::subprocess::StreamEvent;

#[derive(Debug, Clone)]
pub enum SubprocessEvent {
    // ... existing variants ...

    /// Raw stream event for conversation view extraction.
    StreamEvent(StreamEvent),
}
```

### Task 2: Add From conversion for StreamEvent

**Files:** `src/tui/event.rs`

**Changes:**
Add new match arm in `impl From<SubprocessEvent> for AppEvent`:

```rust
impl From<SubprocessEvent> for AppEvent {
    fn from(event: SubprocessEvent) -> Self {
        match event {
            // ... existing arms ...
            SubprocessEvent::StreamEvent(e) => AppEvent::StreamEvent(e),
        }
    }
}
```

### Task 3: Send StreamEvent in parse_and_stream_line

**Files:** `src/build/iteration.rs`

**Changes:**
After parsing the event successfully, send it to TUI for conversation extraction.

Add at line ~38 (after `let event = ...` and before extracting text):

```rust
fn parse_and_stream_line(
    line: &str,
    tui_tx: &mpsc::UnboundedSender<SubprocessEvent>,
) -> Option<StreamEvent> {
    let event = match StreamEvent::parse(line) {
        Ok(e) => e,
        Err(_) => return None,
    };

    // Send raw event for conversation view extraction
    let _ = tui_tx.send(SubprocessEvent::StreamEvent(event.clone()));

    // ... rest of existing code ...
}
```

### Task 4: Update test for SubprocessEvent conversion

**Files:** `src/tui/event.rs` (tests module)

**Changes:**
Add test for new StreamEvent variant:

```rust
#[test]
fn test_subprocess_stream_event_conversion() {
    use crate::subprocess::StreamEvent;

    // Create a minimal stream event for testing
    let json = r#"{"type":"assistant","message":{"content":[{"type":"text","text":"hello"}]}}"#;
    let stream_event = StreamEvent::parse(json).unwrap();

    let subprocess_event = SubprocessEvent::StreamEvent(stream_event.clone());
    let app_event: AppEvent = subprocess_event.into();

    assert!(matches!(app_event, AppEvent::StreamEvent(_)));
}
```

## Verification

1. Build succeeds with no errors
2. All existing tests pass
3. New conversion test passes
4. Run `rslph build` with TUI and press 'c' - conversation pane shows content
5. Conversation includes:
   - Thinking blocks (gray)
   - Tool calls (yellow)
   - Text output (white/default)

## Commit

```
fix(tui): wire StreamEvent to conversation view

- Add SubprocessEvent::StreamEvent variant
- Add From conversion to AppEvent::StreamEvent
- Send StreamEvent in parse_and_stream_line for conversation extraction
- Conversation view now displays thinking, tool calls, and text

Closes Gap 3 (blocker) from 13-UAT.md
```
