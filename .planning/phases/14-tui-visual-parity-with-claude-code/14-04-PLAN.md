---
phase: 14-tui-visual-parity
plan: 04
type: execute
wave: 3
depends_on: ["14-01"]
files_modified:
  - src/tui/conversation.rs
  - src/tui/app.rs
autonomous: true

must_haves:
  truths:
    - "Thinking blocks display with box-drawn borders"
    - "Thinking blocks can be collapsed/expanded with toggle"
    - "Tool calls show as box containers with tool name in header"
    - "Tool parameters display indented within the box"
  artifacts:
    - path: "src/tui/conversation.rs"
      provides: "Box-drawn thinking and tool containers"
      contains: "BorderType::Rounded"
    - path: "src/tui/app.rs"
      provides: "Collapse state tracking for thinking blocks"
      contains: "thinking_collapsed"
  key_links:
    - from: "src/tui/conversation.rs"
      to: "ratatui::widgets::BorderType"
      via: "Block with rounded borders"
      pattern: "BorderType::Rounded"
---

<objective>
Add box-drawn containers for thinking blocks and tool calls in the conversation view.

Purpose: Match Claude Code's visual design where thinking blocks and tool calls are displayed in distinct bordered containers. Thinking blocks use rounded borders and are collapsible; tool calls use plain borders with tool name headers.

Output: Enhanced conversation.rs with box-drawn containers for thinking and tool items.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-tui-visual-parity-with-claude-code/14-RESEARCH.md
@.planning/phases/14-tui-visual-parity-with-claude-code/14-01-SUMMARY.md
@src/tui/conversation.rs
@src/tui/theme.rs
@src/tui/app.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add thinking collapse state to App</name>
  <files>src/tui/app.rs</files>
  <action>
Add a HashMap to track collapsed state for thinking blocks in App:

1. Add import:
   `use std::collections::HashMap;`
   (if not already present)

2. Add field to App struct (near conversation view state):
   ```rust
   /// Collapse state for thinking blocks by index.
   pub thinking_collapsed: HashMap<usize, bool>,
   ```

3. Initialize in Default impl:
   ```rust
   thinking_collapsed: HashMap::new(),
   ```

4. Add helper method:
   ```rust
   /// Toggle collapse state for a thinking block.
   pub fn toggle_thinking_collapse(&mut self, index: usize) {
       let collapsed = self.thinking_collapsed.entry(index).or_insert(false);
       *collapsed = !*collapsed;
   }

   /// Check if a thinking block is collapsed.
   pub fn is_thinking_collapsed(&self, index: usize) -> bool {
       *self.thinking_collapsed.get(&index).unwrap_or(&false)
   }
   ```
  </action>
  <verify>
`cargo check` succeeds.
`grep -n "thinking_collapsed" src/tui/app.rs` shows field and methods.
  </verify>
  <done>App tracks thinking block collapse state with toggle method</done>
</task>

<task type="auto">
  <name>Task 2: Update conversation.rs with box-drawn containers</name>
  <files>src/tui/conversation.rs</files>
  <action>
Update src/tui/conversation.rs to use box-drawn containers:

1. Add imports:
   ```rust
   use ratatui::widgets::BorderType;
   use crate::tui::theme::{colors, styles};
   ```

2. Modify render_item function for Thinking variant:
   - Use Block with BorderType::Rounded and DarkGray border
   - Title: " Thinking " (with spaces for padding)
   - When collapsed, show: "▶ {N} chars" instead of full content
   - When expanded, show italic gray text
   - Add collapse indicator: "▼" for expanded, "▶" for collapsed

3. Modify render_item function for ToolUse variant:
   - Use Block with BorderType::Plain and Yellow border
   - Title: formatted as " {tool_name} " (e.g., " Read ", " Bash ")
   - Title styled bold yellow
   - Parameters/summary indented within the box

4. Modify render_item function for ToolResult variant:
   - Use Block with BorderType::Plain and Cyan border
   - Title: " {tool_name} result "
   - Output content indented within the box, limited to 5 lines

For the line-based rendering approach (current), the boxes can be simulated with line prefixes and styled spans. Or use block.inner() to get inner area for content.

Note: The current render_item returns Vec<Line>. For true box rendering, you may need to return a small block height and render separately, OR simulate box appearance with Unicode line characters in the spans.

Simplest approach for line-based output:
```rust
// For thinking block (expanded):
vec![
    Line::from(Span::styled("┌─ Thinking ─────────────────────┐", gray_style)),
    // content lines with "│ " prefix
    Line::from(Span::styled("└────────────────────────────────┘", gray_style)),
]

// For thinking block (collapsed):
vec![
    Line::from(Span::styled("▶ Thinking (123 chars)", gray_style)),
]
```
  </action>
  <verify>
`cargo check` succeeds.
`grep -n "BorderType\|Thinking" src/tui/conversation.rs` shows box usage or simulation.
  </verify>
  <done>Thinking blocks show with box borders and are collapsible; tool calls show with box headers</done>
</task>

<task type="auto">
  <name>Task 3: Update render_conversation to pass collapse state</name>
  <files>src/tui/conversation.rs</files>
  <action>
Update render_conversation function signature and implementation:

1. Add parameter for collapse state lookup:
   ```rust
   pub fn render_conversation(
       frame: &mut Frame,
       area: Rect,
       items: &[ConversationItem],
       scroll_offset: usize,
       thinking_collapsed: &HashMap<usize, bool>,
   )
   ```

2. Pass the collapse state to render_item for Thinking items:
   - Track item index
   - For Thinking items, check if collapsed and render accordingly

3. Update callers in:
   - src/tui/ui.rs (render function calls render_conversation)
   - src/tui/plan_tui.rs (if it calls render_conversation)

The collapse state determines whether thinking blocks show full content or just the collapsed indicator.
  </action>
  <verify>
`cargo check` succeeds.
`grep -n "thinking_collapsed" src/tui/conversation.rs` shows parameter usage.
  </verify>
  <done>render_conversation accepts collapse state and passes to item rendering</done>
</task>

</tasks>

<verification>
```bash
# Check compilation
cargo check

# Verify App changes
grep -n "thinking_collapsed" src/tui/app.rs
grep -n "toggle_thinking_collapse" src/tui/app.rs

# Verify conversation.rs changes
grep -n "BorderType\|Rounded" src/tui/conversation.rs
grep -n "Thinking" src/tui/conversation.rs

# Verify theme usage
grep -n "use crate::tui::theme" src/tui/conversation.rs

# Check callers updated
grep -n "render_conversation" src/tui/ui.rs
grep -n "render_conversation" src/tui/plan_tui.rs
```
</verification>

<success_criteria>
1. App has thinking_collapsed HashMap field
2. App has toggle_thinking_collapse and is_thinking_collapsed methods
3. Thinking blocks render with box appearance (rounded borders or Unicode simulation)
4. Thinking blocks show collapsed state with "▶" indicator
5. Tool calls render with box appearance (tool name in header)
6. Tool results render with box appearance
7. render_conversation accepts thinking collapse state
8. All callers of render_conversation updated with new parameter
9. `cargo build` succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/14-tui-visual-parity-with-claude-code/14-04-SUMMARY.md`
</output>
