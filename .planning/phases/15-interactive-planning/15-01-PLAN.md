---
phase: 15-interactive-planning
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/subprocess/stream_json.rs
  - src/subprocess/mod.rs
autonomous: true

must_haves:
  truths:
    - "Session ID is extracted from init events in stream-json output"
    - "AskUserQuestion tool calls are detected from stream events"
    - "Questions are parsed from AskUserQuestion input payload"
  artifacts:
    - path: "src/subprocess/stream_json.rs"
      provides: "Session ID extraction and AskUserQuestion detection"
      contains: "session_id"
  key_links:
    - from: "StreamEvent"
      to: "AskUserQuestion detection"
      via: "extract_ask_user_questions method"
      pattern: "AskUserQuestion"
---

<objective>
Add session ID capture and AskUserQuestion detection to the stream-json parser.

Purpose: Enable interactive planning by extracting session ID for resume capability and detecting when Claude asks clarifying questions.

Output: Extended StreamEvent and StreamResponse with session_id and question detection methods.
</objective>

<execution_context>
@/Users/vmakaev/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vmakaev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-interactive-planning/15-RESEARCH.md
@src/subprocess/stream_json.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add session_id field to StreamEvent and extraction method</name>
  <files>src/subprocess/stream_json.rs</files>
  <action>
    1. Add session_id field to StreamEvent struct (Option<String>)

    2. Add is_init_event() method to StreamEvent:
       - Returns true if event_type == "system" and has subtype == "init"
       - Check for subtype in the raw JSON (may need to add subtype field to struct)

    3. Add extract_session_id() method to StreamEvent:
       - For init events, return the session_id field
       - For other events, return None

    4. The init event structure is:
       ```json
       {"type":"system","subtype":"init","session_id":"fa0f513d-ca3f-447f-aaa3-9d12ffb6a75f",...}
       ```
  </action>
  <verify>cargo test -p rslph stream_json -- --nocapture</verify>
  <done>StreamEvent has session_id field and extraction methods for init events</done>
</task>

<task type="auto">
  <name>Task 2: Add AskUserQuestion detection and parsing</name>
  <files>src/subprocess/stream_json.rs</files>
  <action>
    1. Add struct AskUserQuestion to represent parsed questions:
       ```rust
       #[derive(Debug, Clone)]
       pub struct AskUserQuestion {
           pub questions: Vec<String>,
       }
       ```

    2. Add extract_ask_user_questions() method to StreamEvent:
       - Check if event contains tool_use blocks
       - For each tool_use, check if name == "AskUserQuestion"
       - Parse the input.questions array (it's a JSON array of strings)
       - Return Option<AskUserQuestion>

    3. The AskUserQuestion tool_use structure is:
       ```json
       {"type":"assistant","content":[{"type":"tool_use","name":"AskUserQuestion","input":{"questions":["Question 1?","Question 2?"]}}]}
       ```

    4. Add unit tests:
       - Test parsing init event with session_id
       - Test parsing assistant event with AskUserQuestion
       - Test that non-AskUserQuestion tool uses return None
  </action>
  <verify>cargo test -p rslph stream_json -- --nocapture</verify>
  <done>AskUserQuestion struct and extraction method implemented with tests</done>
</task>

<task type="auto">
  <name>Task 3: Add session_id tracking to StreamResponse</name>
  <files>src/subprocess/stream_json.rs</files>
  <action>
    1. Add session_id field to StreamResponse struct (Option<String>)

    2. Add questions field to StreamResponse (Vec<AskUserQuestion>)

    3. Update process_event() to:
       - Extract and store session_id from init events (first one wins)
       - Collect AskUserQuestion events into the questions vector

    4. Add has_questions() method to StreamResponse:
       - Returns true if questions vector is non-empty

    5. Add get_all_questions() method to StreamResponse:
       - Returns flattened Vec<String> of all questions from all AskUserQuestion events

    6. Add tests for StreamResponse accumulating session_id and questions
  </action>
  <verify>cargo test -p rslph stream_json -- --nocapture</verify>
  <done>StreamResponse tracks session_id and accumulates questions from stream</done>
</task>

</tasks>

<verification>
1. Run all stream_json tests: `cargo test -p rslph stream_json`
2. Verify new structs and methods are exported in mod.rs
3. Run cargo clippy to ensure no new warnings
</verification>

<success_criteria>
- StreamEvent can extract session_id from init events
- StreamEvent can detect and parse AskUserQuestion tool calls
- StreamResponse accumulates session_id and questions across the stream
- All tests pass with no clippy warnings
</success_criteria>

<output>
After completion, create `.planning/phases/15-interactive-planning/15-01-SUMMARY.md`
</output>
