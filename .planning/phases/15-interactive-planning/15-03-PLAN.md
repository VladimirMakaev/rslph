---
phase: 15-interactive-planning
plan: 03
type: execute
wave: 3
depends_on: ["15-02"]
files_modified:
  - src/planning/command.rs
  - src/subprocess/runner.rs
autonomous: true

must_haves:
  truths:
    - "Session can be resumed with --resume flag and session_id"
    - "User answers are sent to Claude in the resume request"
    - "Resume response is parsed as the final progress file"
    - "Multiple rounds of questions are supported"
  artifacts:
    - path: "src/planning/command.rs"
      provides: "Session resume functionality with answer passthrough"
      contains: "resume_session"
  key_links:
    - from: "run_adaptive_planning"
      to: "resume_session"
      via: "session resume after answer collection"
      pattern: "resume"
---

<objective>
Implement session resume capability to continue Claude sessions after collecting user answers.

Purpose: Complete the interactive planning loop by resuming the session with user-provided answers, allowing Claude to produce a valid progress file.

Output: Full session resume support for adaptive planning mode.
</objective>

<execution_context>
@/Users/vmakaev/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vmakaev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-interactive-planning/15-RESEARCH.md
@.planning/phases/15-interactive-planning/15-01-SUMMARY.md
@.planning/phases/15-interactive-planning/15-02-SUMMARY.md
@src/planning/command.rs
@src/subprocess/runner.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create resume_session helper function</name>
  <files>src/planning/command.rs</files>
  <action>
    1. Add async function resume_session():
       ```rust
       async fn resume_session(
           session_id: &str,
           message: &str,
           no_dsp: bool,
           config: &Config,
           working_dir: &Path,
           cancel_token: CancellationToken,
           timeout: Duration,
       ) -> color_eyre::Result<StreamResponse>
       ```

    2. Implementation:
       - Build Claude CLI args with --resume flag:
         ```
         ["-p", "--verbose", "--output-format", "stream-json", "--resume", session_id, message]
         ```
       - Spawn Claude using ClaudeRunner::spawn()
       - Run with timeout and collect output
       - Parse JSONL into StreamResponse
       - Return the accumulated response

    3. Note: Resume doesn't need system prompt - it continues the existing session
  </action>
  <verify>cargo build -p rslph</verify>
  <done>resume_session function implemented to continue Claude sessions</done>
</task>

<task type="auto">
  <name>Task 2: Implement interactive loop in adaptive planning</name>
  <files>src/planning/command.rs</files>
  <action>
    1. Refactor run_adaptive_planning() to use an interactive loop:
       - Run initial planning as before
       - Check if stream_response.has_questions()
       - If yes, enter a loop (max 5 iterations to prevent infinite loops):
         a. Display questions
         b. Collect user answers
         c. Format answers for resume
         d. Call resume_session() with session_id and formatted answers
         e. Check if new response has questions
         f. If no questions, break loop with final response
       - Parse final response into ProgressFile

    2. Track accumulated tokens across all resume calls

    3. Handle edge cases:
       - If session_id is None but has questions, fall back to showing questions and continuing with incomplete output
       - If resume fails, show error and continue with what we have

    4. Add progress indicators:
       - Print "Round N: Collecting answers..." for each round
       - Print "Resuming session..." before each resume call
  </action>
  <verify>cargo build -p rslph</verify>
  <done>Adaptive planning supports multi-round interactive Q&A with session resume</done>
</task>

<task type="auto">
  <name>Task 3: Add fallback handling for no questions scenario</name>
  <files>src/planning/command.rs</files>
  <action>
    1. Ensure INTER-07 (fallback handling) is satisfied:
       - If no questions asked, proceed normally without any changes
       - The existing flow should work unchanged when Claude doesn't ask questions

    2. Add logging/tracing for debugging:
       - [TRACE] Session ID captured: {id}
       - [TRACE] Questions detected: {count}
       - [TRACE] Resuming session with answers

    3. Update token display to show totals across all resume rounds:
       - Accumulate TokenUsage across initial run + all resumes
       - Display final totals to user

    4. Write tests (integration style, may use mock):
       - Test that no-question flow works unchanged
       - Test that session_id is captured from mock output
       - Test that questions are detected and formatted correctly
  </action>
  <verify>cargo test -p rslph planning -- --nocapture</verify>
  <done>Fallback handling ensures normal flow when no questions asked</done>
</task>

</tasks>

<verification>
1. cargo build compiles successfully
2. cargo test passes all tests
3. cargo clippy shows no new warnings
4. Manual test: Run plan command and verify session resume works (if Claude asks questions)
</verification>

<success_criteria>
- resume_session() function can continue a Claude session with answers
- Adaptive planning loops through Q&A rounds until Claude produces final output
- Token usage is accumulated and displayed correctly
- Normal flow works unchanged when no questions asked
</success_criteria>

<output>
After completion, create `.planning/phases/15-interactive-planning/15-03-SUMMARY.md`
</output>
