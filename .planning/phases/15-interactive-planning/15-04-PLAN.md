---
phase: 15-interactive-planning
plan: 04
type: execute
wave: 3
depends_on: ["15-02"]
files_modified:
  - src/planning/command.rs
  - src/tui/plan_tui.rs
autonomous: true

must_haves:
  truths:
    - "TUI mode displays questions when Claude asks them"
    - "TUI provides input mode for user to type answers"
    - "TUI shows visual feedback during session resume"
    - "User can complete full Q&A flow without leaving TUI"
  artifacts:
    - path: "src/tui/plan_tui.rs"
      provides: "TUI input mode for interactive Q&A"
      contains: "InputMode"
  key_links:
    - from: "run_plan_tui"
      to: "InputMode"
      via: "TUI state transition for answer input"
      pattern: "input_mode"
---

<objective>
Add TUI mode support for the question/answer flow during interactive planning.

Purpose: Enable users to answer Claude's clarifying questions within the TUI interface, maintaining the visual experience.

Output: Enhanced plan TUI with input mode for collecting answers and visual feedback during session resume.
</objective>

<execution_context>
@/Users/vmakaev/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vmakaev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-interactive-planning/15-RESEARCH.md
@.planning/phases/15-interactive-planning/15-01-SUMMARY.md
@.planning/phases/15-interactive-planning/15-02-SUMMARY.md
@.planning/phases/15-interactive-planning/15-03-SUMMARY.md
@src/tui/plan_tui.rs
@src/planning/command.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add InputMode and input state to PlanTuiState</name>
  <files>src/tui/plan_tui.rs</files>
  <action>
    1. Add InputMode enum:
       ```rust
       #[derive(Debug, Clone, PartialEq)]
       pub enum InputMode {
           /// Normal viewing mode
           Normal,
           /// User is answering questions
           AnsweringQuestions,
       }
       ```

    2. Add fields to PlanTuiState:
       - input_mode: InputMode (default Normal)
       - pending_questions: Vec<String> (questions waiting for answers)
       - input_buffer: String (current user input)
       - session_id: Option<String> (for resume)

    3. Add methods:
       - enter_question_mode(questions: Vec<String>, session_id: String)
       - exit_question_mode() -> String (returns collected input)
       - handle_input_char(c: char) - add char to buffer
       - handle_input_backspace() - remove last char
       - handle_input_newline() - add newline to buffer
  </action>
  <verify>cargo build -p rslph</verify>
  <done>PlanTuiState has input mode and buffer for collecting answers</done>
</task>

<task type="auto">
  <name>Task 2: Render question input area in TUI</name>
  <files>src/tui/plan_tui.rs</files>
  <action>
    1. Add render_question_input() function:
       - Show questions in a bordered box at the top
       - Show input area with cursor below
       - Display instructions: "Type your answers, then press Ctrl+Enter to submit"

    2. Modify render_plan_tui() to check input_mode:
       - If Normal: render as before
       - If AnsweringQuestions: split layout to show questions + input area

    3. Layout for AnsweringQuestions mode:
       - Top: Header with status "Answering Questions..."
       - Middle-top: Questions box (scrollable if many questions)
       - Middle-bottom: Input text area with current buffer
       - Bottom: Footer with submit instructions

    4. Use a different color scheme to indicate input mode (e.g., yellow border)
  </action>
  <verify>cargo build -p rslph</verify>
  <done>TUI renders question input interface when in AnsweringQuestions mode</done>
</task>

<task type="auto">
  <name>Task 3: Handle keyboard input for answer entry</name>
  <files>src/tui/plan_tui.rs</files>
  <action>
    1. Update run_plan_tui() to handle input mode:
       - In Normal mode: existing keyboard handling
       - In AnsweringQuestions mode:
         - Regular keys: add to input buffer
         - Backspace: remove last char
         - Enter: add newline to buffer
         - Ctrl+Enter (or Ctrl+D): submit answers, exit input mode

    2. Add new AppEvent variants if needed, or handle at the TUI level:
       - The existing EventHandler may need extension for text input
       - Alternative: Process raw crossterm events in AnsweringQuestions mode

    3. When answers are submitted:
       - Set a flag or return value to signal main loop
       - The main loop (run_tui_planning) will handle resume

    4. Add visual cursor indicator in the input area
  </action>
  <verify>cargo build -p rslph</verify>
  <done>TUI handles text input and submission for answering questions</done>
</task>

<task type="auto">
  <name>Task 4: Integrate TUI input mode with planning command</name>
  <files>src/planning/command.rs, src/tui/plan_tui.rs</files>
  <action>
    1. Modify run_tui_planning() to handle questions:
       - After initial stream completes, check if stream_response.has_questions()
       - If yes:
         a. Send questions to TUI via a new event type (e.g., PlanTuiEvent::QuestionsAsked)
         b. TUI enters AnsweringQuestions mode
         c. Wait for user to submit answers
         d. Call resume_session() with session_id and answers
         e. Stream resume output to TUI
         f. Repeat if more questions asked

    2. Add PlanTuiEvent variant:
       ```rust
       QuestionsAsked {
           questions: Vec<String>,
           session_id: String,
       }
       ```

    3. The TUI will need to signal back when answers are ready:
       - Option A: Return from run_plan_tui with answers in state
       - Option B: Use a channel back to the command
       - Choose Option A for simplicity - run_plan_tui returns when answers submitted

    4. Handle the resume loop similar to CLI mode but with TUI feedback
  </action>
  <verify>cargo test -p rslph</verify>
  <done>TUI mode fully supports interactive Q&A with session resume</done>
</task>

</tasks>

<verification>
1. cargo build compiles successfully
2. cargo test passes all tests
3. cargo clippy shows no new warnings
4. Manual test: Run `rslph plan --adaptive "idea"` and verify TUI Q&A works
</verification>

<success_criteria>
- TUI enters input mode when questions are detected
- Users can type multi-line answers in the TUI
- Submit action (Ctrl+Enter) sends answers and resumes session
- Visual feedback shows during resume (spinner, status)
- Full Q&A loop works within TUI without exiting
</success_criteria>

<output>
After completion, create `.planning/phases/15-interactive-planning/15-04-SUMMARY.md`
</output>
