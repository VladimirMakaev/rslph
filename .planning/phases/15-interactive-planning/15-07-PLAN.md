---
phase: 15-interactive-planning
plan: 07
type: execute
wave: 2
depends_on: ["15-05", "15-06"]
files_modified:
  - tests/e2e/test_interactive_planning.rs
  - tests/e2e/main.rs
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "E2E tests verify session ID is captured from fake_claude"
    - "E2E tests verify AskUserQuestion events are detected"
    - "E2E tests verify fallback (no questions) works correctly"
  artifacts:
    - path: "tests/e2e/test_interactive_planning.rs"
      provides: "E2E tests for interactive planning Q&A flow"
      min_lines: 50
    - path: "tests/e2e/main.rs"
      provides: "Module declaration for test_interactive_planning"
      contains: "mod test_interactive_planning"
  key_links:
    - from: "tests/e2e/test_interactive_planning.rs"
      to: "tests/fake_claude_lib/prebuilt.rs"
      via: "Uses interactive_planning scenario"
      pattern: "prebuilt::interactive_planning"
---

<objective>
Add E2E tests for interactive planning Q&A flow

Purpose: Verify that the Phase 15 features work end-to-end using the fake_claude infrastructure. Tests exercise session ID capture, AskUserQuestion detection, and fallback behavior.

Output: New E2E test file with tests for INTER-01, INTER-02, INTER-03, and INTER-07 requirements.
</objective>

<execution_context>
@/Users/vmakaev/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vmakaev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-interactive-planning/15-GAP-RESEARCH.md
@.planning/phases/15-interactive-planning/15-05-SUMMARY.md

# Existing E2E test patterns
@tests/e2e/test_rslph_integration.rs
@tests/e2e/helpers.rs

# Fake Claude infrastructure
@tests/fake_claude_lib/prebuilt.rs
@tests/fake_claude_lib/scenario.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create interactive planning E2E test file</name>
  <files>tests/e2e/test_interactive_planning.rs</files>
  <action>
Create a new E2E test file for interactive planning tests:

```rust
//! E2E tests for Phase 15: Interactive Planning Input
//!
//! These tests verify that the Q&A infrastructure works end-to-end:
//! - Session ID capture from init events (INTER-01)
//! - AskUserQuestion detection (INTER-02)
//! - Question parsing (INTER-03)
//! - Fallback when no questions asked (INTER-07)

use assert_cmd::Command;
use predicates::prelude::*;
use std::fs;
use tempfile::TempDir;

// Import fake_claude_lib modules
#[path = "../fake_claude_lib/mod.rs"]
mod fake_claude_lib;

use fake_claude_lib::prebuilt;
use fake_claude_lib::scenario::ScenarioBuilder;

/// Test INTER-07: Fallback when no questions asked
///
/// When Claude doesn't ask questions, the normal plan flow should continue
/// without entering the Q&A loop.
#[test]
fn test_no_questions_proceeds_normally() {
    let temp_dir = TempDir::new().expect("Failed to create temp dir");
    let initial_file = temp_dir.path().join("INITIAL.md");
    fs::write(&initial_file, "# Build a calculator\n\nSimple CLI calculator.").unwrap();

    // Use calculator scenario which doesn't ask questions
    let handle = prebuilt::calculator().build();

    let mut cmd = Command::cargo_bin("rslph").expect("Failed to find rslph binary");
    for (key, val) in handle.env_vars() {
        cmd.env(key, val);
    }

    cmd.arg("plan")
        .arg(&initial_file)
        .current_dir(temp_dir.path())
        .assert()
        .success();

    // Verify progress.md was created
    let progress_path = temp_dir.path().join("progress.md");
    assert!(progress_path.exists(), "progress.md should be created");

    let content = fs::read_to_string(&progress_path).unwrap();
    assert!(content.contains("Calculator"), "Should contain Calculator project name");
}

/// Test that session ID is captured from init event
///
/// This is a structural test - we verify the fake_claude scenario
/// with session_id produces output that the parser can handle.
#[test]
fn test_session_id_in_fake_claude_output() {
    // Create a scenario with session ID
    let handle = ScenarioBuilder::new()
        .with_session_id("test-e2e-session-abc")
        .respond_with_text(r#"# Progress: Test

## Status

RALPH_DONE

## Tasks

### Phase 1

- [x] Done
"#)
        .build();

    let temp_dir = TempDir::new().expect("Failed to create temp dir");
    let initial_file = temp_dir.path().join("INITIAL.md");
    fs::write(&initial_file, "# Test project").unwrap();

    let mut cmd = Command::cargo_bin("rslph").expect("Failed to find rslph binary");
    for (key, val) in handle.env_vars() {
        cmd.env(key, val);
    }

    cmd.arg("plan")
        .arg("--no-tui")
        .arg(&initial_file)
        .current_dir(temp_dir.path())
        .assert()
        .success();

    // Progress file should be created (session ID was handled correctly)
    let progress_path = temp_dir.path().join("progress.md");
    assert!(progress_path.exists(), "progress.md should be created");
}

/// Test that AskUserQuestion events are emitted by fake_claude
///
/// Verifies that the interactive_planning scenario produces the expected
/// stream-json output with AskUserQuestion tool_use events.
#[test]
fn test_interactive_scenario_builds_correctly() {
    // Verify the scenario can be built without panicking
    let handle = prebuilt::interactive_planning().build();

    // Verify handle is configured correctly
    let env_vars = handle.env_vars();
    assert_eq!(env_vars.len(), 2, "Should have FAKE_CLAUDE_CONFIG and RSLPH_CLAUDE_CMD");

    // Verify config file exists
    assert!(handle.config_path.exists(), "Config file should exist");

    // Read and verify config contains expected structure
    let config_content = fs::read_to_string(&handle.config_path).unwrap();
    assert!(config_content.contains("AskUserQuestion"), "Config should contain AskUserQuestion");
    assert!(config_content.contains("test-session-123"), "Config should contain session ID");
}

/// Test that multi-round Q&A scenario is properly configured
#[test]
fn test_multi_round_scenario_builds_correctly() {
    let handle = prebuilt::multi_round_qa().build();

    // Verify config file exists and contains expected content
    let config_content = fs::read_to_string(&handle.config_path).unwrap();
    assert!(config_content.contains("multi-session-456"), "Config should contain multi-round session ID");

    // Count invocations (should be 3: question, question, answer)
    let invocation_count = config_content.matches("\"events\"").count();
    assert!(invocation_count >= 3, "Should have at least 3 invocations for multi-round");
}
```

Note: These tests verify the infrastructure works. Full E2E tests of the Q&A flow with stdin mocking would require additional test harness work. The key verification is that:
1. Scenarios build correctly
2. Config contains expected AskUserQuestion content
3. Fallback (no questions) still works
  </action>
  <verify>cargo test --test e2e test_interactive -- --nocapture 2>&1 | tail -30</verify>
  <done>New E2E test file exists with tests for INTER-01, INTER-02, INTER-03, INTER-07</done>
</task>

<task type="auto">
  <name>Task 2: Add module to E2E test main.rs</name>
  <files>tests/e2e/main.rs</files>
  <action>
Read the existing tests/e2e/main.rs and add the new module declaration:

Add this line with the other mod declarations:
```rust
mod test_interactive_planning;
```

The line should be added alphabetically with the other test modules.
  </action>
  <verify>grep "test_interactive_planning" tests/e2e/main.rs</verify>
  <done>tests/e2e/main.rs includes mod test_interactive_planning declaration</done>
</task>

</tasks>

<verification>
1. `cargo test --test e2e test_interactive` runs the new tests
2. `test_no_questions_proceeds_normally` passes (INTER-07)
3. `test_session_id_in_fake_claude_output` passes (INTER-01)
4. `test_interactive_scenario_builds_correctly` passes (INTER-02, INTER-03)
5. `test_multi_round_scenario_builds_correctly` passes (INTER-06)
</verification>

<success_criteria>
- New test file tests/e2e/test_interactive_planning.rs exists
- Module is declared in tests/e2e/main.rs
- All new E2E tests pass
- Tests verify session ID handling
- Tests verify AskUserQuestion scenario structure
- Tests verify fallback (no questions) behavior
</success_criteria>

<output>
After completion, create `.planning/phases/15-interactive-planning/15-07-SUMMARY.md`
</output>
