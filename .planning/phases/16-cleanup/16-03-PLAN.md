---
phase: 16-cleanup
plan: 03
type: execute
wave: 2
depends_on: ["16-02"]
files_modified:
  - tests/e2e/test_rslph_integration.rs
  - tests/e2e/test_eval_integration.rs
  - tests/e2e/test_interactive_planning.rs
  - tests/e2e/test_token_tracking.rs
autonomous: true

must_haves:
  truths:
    - "All E2E tests compile without --no-tui flag"
    - "E2E tests use library functions directly instead of assert_cmd subprocess"
    - "cargo test passes with all E2E tests (not just unit tests)"
  artifacts:
    - path: "tests/e2e/test_rslph_integration.rs"
      provides: "Integration tests using library directly"
      not_contains: "--no-tui"
    - path: "tests/e2e/test_eval_integration.rs"
      provides: "Eval integration tests using library directly"
      not_contains: "--no-tui"
    - path: "tests/e2e/test_interactive_planning.rs"
      provides: "Planning tests using library directly"
      not_contains: "--no-tui"
  key_links:
    - from: "tests/e2e/*.rs"
      to: "src/build/command.rs"
      via: "direct function calls instead of subprocess"
      pattern: "rslph::(build|planning|eval)"
---

<objective>
Restructure E2E tests to call library functions directly instead of using assert_cmd subprocess with --no-tui flag.

Purpose: With --no-tui removed, E2E tests can no longer use `assert_cmd::Command` to run the binary in headless mode. Tests must be restructured to test command functions directly, following the established pattern from tui_tests.rs which uses TestBackend.

Output: E2E tests that test command logic directly without subprocess execution. All tests pass.
</objective>

<execution_context>
@/Users/vmakaev/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vmakaev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-cleanup/16-RESEARCH.md
@.planning/phases/16-cleanup/16-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert test_rslph_integration.rs to library-direct tests</name>
  <files>
    - tests/e2e/test_rslph_integration.rs
  </files>
  <action>
    This file has 11 tests using `--no-tui`. Convert each to call library functions directly.

    **Pattern to follow (from existing tui_tests.rs):**

    ```rust
    use rslph::build::command::run_build_command;
    use rslph::config::Config;

    #[tokio::test]
    async fn test_build_completes_successfully() {
        // Setup workspace with ScenarioBuilder (existing pattern)
        let workspace = ScenarioBuilder::new()
            .with_progress_file("...")
            .build();

        // Create config with TUI disabled
        let config = Config {
            tui_enabled: false,  // This config field still exists
            ..Config::default()
        };

        // Call library function directly
        let result = run_build_command(
            workspace.progress_path(),
            workspace.claude_cmd(),
            config,
        ).await;

        // Assert on result
        assert!(result.is_ok());
    }
    ```

    **For each test in test_rslph_integration.rs:**

    1. Remove `Command::cargo_bin("rslph")` and `arg("--no-tui")`
    2. Import the relevant command function from rslph library
    3. Create Config with `tui_enabled: false`
    4. Call the function directly with appropriate parameters
    5. Assert on the returned Result instead of command output

    **Key tests to convert:**
    - Build command tests -> call `run_build_command()` directly
    - Plan command tests -> call `run_plan_command()` directly

    **If a test relies on stdout/stderr capture from subprocess:**
    - Modify the test to check the function's return value instead
    - Or use a logging capture mechanism if output verification is critical

    Add necessary imports at top of file:
    ```rust
    use rslph::build::command::run_build_command;
    use rslph::planning::command::run_plan_command;
    use rslph::config::Config;
    ```
  </action>
  <verify>
    - `cargo test --test test_rslph_integration` compiles
    - `cargo test --test test_rslph_integration` passes
    - `grep -n "no-tui\|no_tui" tests/e2e/test_rslph_integration.rs` returns no matches
  </verify>
  <done>
    test_rslph_integration.rs uses library functions directly. All 11 tests pass without --no-tui.
  </done>
</task>

<task type="auto">
  <name>Task 2: Convert test_eval_integration.rs and test_token_tracking.rs</name>
  <files>
    - tests/e2e/test_eval_integration.rs
    - tests/e2e/test_token_tracking.rs
  </files>
  <action>
    **test_eval_integration.rs** has 7 tests using `--no-tui`. Convert each:

    ```rust
    use rslph::eval::command::run_eval_command;
    use rslph::config::Config;

    #[tokio::test]
    async fn test_eval_runs_successfully() {
        let workspace = setup_eval_workspace();

        let config = Config {
            tui_enabled: false,
            ..Config::default()
        };

        let result = run_eval_command(
            eval_config,
            config,
        ).await;

        assert!(result.is_ok());
    }
    ```

    **test_token_tracking.rs** has 1 test using `--no-tui`. Convert it similarly.

    **For each test:**
    1. Remove `Command::cargo_bin("rslph")` pattern
    2. Import `run_eval_command` from rslph library
    3. Create Config with `tui_enabled: false`
    4. Call function directly
    5. Assert on return value

    **If test checks stdout for token counts:**
    - Modify to check the function's return value which should contain token data
    - Or add a way to capture/verify token data from the function result
  </action>
  <verify>
    - `cargo test --test test_eval_integration` compiles and passes
    - `cargo test --test test_token_tracking` compiles and passes
    - `grep -n "no-tui\|no_tui" tests/e2e/test_eval_integration.rs tests/e2e/test_token_tracking.rs` returns no matches
  </verify>
  <done>
    test_eval_integration.rs (7 tests) and test_token_tracking.rs (1 test) converted to library-direct. All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 3: Convert test_interactive_planning.rs</name>
  <files>
    - tests/e2e/test_interactive_planning.rs
  </files>
  <action>
    **test_interactive_planning.rs** has 3 tests using `--no-tui`. These test interactive Q&A during planning.

    **Challenge:** Interactive planning tests may require simulating user input. Options:

    1. **If tests use fake Claude that doesn't require real interaction:**
       - Convert to library-direct calls
       - The fake Claude should handle the full flow

    2. **If tests need to simulate user answers:**
       - Use the session resume mechanism (answer persistence in progress file)
       - Or pass pre-recorded answers via test configuration

    **Conversion pattern:**

    ```rust
    use rslph::planning::command::run_plan_command;
    use rslph::config::Config;

    #[tokio::test]
    async fn test_planning_with_questions() {
        let workspace = ScenarioBuilder::new()
            .with_claude_response("...questions...")
            .build();

        let config = Config {
            tui_enabled: false,
            ..Config::default()
        };

        // For interactive tests, may need to:
        // 1. Pre-populate answers file
        // 2. Use a mock input source
        // 3. Configure Claude fake to not ask questions

        let result = run_plan_command(
            plan_args,
            config,
        ).await;

        assert!(result.is_ok());
    }
    ```

    **If interactive simulation is too complex:**
    - Simplify tests to verify non-interactive planning works
    - Add TODO comment for Phase 20 (E2E Tests) to add proper interactive tests
  </action>
  <verify>
    - `cargo test --test test_interactive_planning` compiles and passes
    - `grep -n "no-tui\|no_tui" tests/e2e/test_interactive_planning.rs` returns no matches
  </verify>
  <done>
    test_interactive_planning.rs (3 tests) converted to library-direct or simplified. All tests pass.
  </done>
</task>

</tasks>

<verification>
Run the following commands to verify complete E2E test conversion:

1. **All E2E tests compile:**
   ```bash
   cargo test --test test_rslph_integration --no-run
   cargo test --test test_eval_integration --no-run
   cargo test --test test_interactive_planning --no-run
   cargo test --test test_token_tracking --no-run
   ```

2. **All E2E tests pass:**
   ```bash
   cargo test --test test_rslph_integration
   cargo test --test test_eval_integration
   cargo test --test test_interactive_planning
   cargo test --test test_token_tracking
   ```

3. **No --no-tui references:**
   ```bash
   grep -rn "no-tui\|no_tui" tests/e2e/
   # Should return no matches
   ```

4. **Full test suite passes:**
   ```bash
   cargo test
   ```
</verification>

<success_criteria>
1. `grep -rn "no-tui" tests/e2e/` returns zero matches
2. `grep -rn "no_tui" tests/e2e/` returns zero matches
3. `cargo test` passes with all tests (unit + E2E)
4. No tests are marked `#[ignore]` due to --no-tui removal
5. E2E tests call library functions directly, not subprocess
</success_criteria>

<output>
After completion, create `.planning/phases/16-cleanup/16-03-SUMMARY.md`
</output>
