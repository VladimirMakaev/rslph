---
phase: 17-basic-mode-alignment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prompts/basic/PROMPT_plan.md
  - prompts/basic/PROMPT_build.md
  - tests/e2e/test_basic_mode_alignment.rs
  - tests/e2e/mod.rs
autonomous: true

must_haves:
  truths:
    - "Basic mode PROMPT_build.md contains quality check guidance before marking tasks complete"
    - "Basic mode PROMPT_plan.md contains story sizing guidance (2-3 sentences)"
    - "Basic mode PROMPT_build.md emphasizes learnings documentation in Recent Attempts"
    - "E2E test verifies basic mode loop behavior matches portableralph"
    - "MODE-04 (progress.md format) is semantically equivalent to portableralph's prd.json + progress.txt - no changes needed"
  artifacts:
    - path: "prompts/basic/PROMPT_plan.md"
      provides: "Planning prompt with story sizing guidance"
      contains: "2-3 sentences"
    - path: "prompts/basic/PROMPT_build.md"
      provides: "Build prompt with quality check and learnings guidance"
      contains: "quality checks"
    - path: "tests/e2e/test_basic_mode_alignment.rs"
      provides: "E2E verification of portableralph alignment"
      exports: ["test_basic_mode_one_task_per_iteration", "test_basic_mode_ralph_done_termination", "test_basic_mode_vcs_commit_on_completion"]
  key_links:
    - from: "prompts/basic/PROMPT_build.md"
      to: "src/prompts/defaults.rs"
      via: "include_str! at compile time"
      pattern: 'include_str!.*prompts/basic/PROMPT_build\.md'
    - from: "prompts/basic/PROMPT_plan.md"
      to: "src/prompts/defaults.rs"
      via: "include_str! at compile time (line 6)"
      pattern: 'include_str!.*prompts/basic/PROMPT_plan\.md'
    - from: "tests/e2e/test_basic_mode_alignment.rs"
      to: "tests/e2e/mod.rs"
      via: "mod declaration"
      pattern: 'mod test_basic_mode_alignment'
---

<objective>
Align basic mode prompts with portableralph reference implementation and add verification tests.

Purpose: MODE-02 requires prompt alignment with portableralph. Research confirmed MODE-03, MODE-04, MODE-05 are already implemented correctly in the build loop. MODE-04 (progress file format) was verified to be semantically equivalent to portableralph's prd.json + progress.txt structure - both track tasks with descriptions, statuses, and details - so no changes are required.

Output: Updated prompt files with quality check, story sizing, and learnings guidance. E2E test verifying portableralph behavior alignment.
</objective>

<execution_context>
@/Users/vmakaev/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vmakaev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-basic-mode-alignment/17-RESEARCH.md
@prompts/basic/PROMPT_plan.md
@prompts/basic/PROMPT_build.md
@tests/e2e/test_rslph_integration.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update basic mode prompts with portableralph alignment</name>
  <files>
    prompts/basic/PROMPT_plan.md
    prompts/basic/PROMPT_build.md
  </files>
  <action>
Update PROMPT_plan.md to add story sizing guidance. In the Guidelines section, add:

```
8. **Story Sizing**: Each task should be describable in 2-3 sentences. If it requires more explanation, split it into smaller tasks.
```

Update PROMPT_build.md to add:

1. Quality check guidance in the Critical Rules section (add as rule 5):
```
5. **QUALITY CHECKS** - Before marking a task complete:
   - Verify implementation works as expected
   - Run any relevant quality checks (tests, typecheck, lint) if available
   - Keep changes focused and minimal
```

2. Enhanced learnings documentation in the Failure Memory section. Replace the current format guidance with:
```
When documenting an attempt, include learnings for future iterations:
### Iteration [N]
- Tried: [what you attempted]
- Result: [what happened]
- Learnings: [patterns discovered, gotchas encountered, useful context]
- Next: [what to try differently]
```

These changes align with portableralph's emphasis on quality checks before commit and learnings persistence across iterations.
  </action>
  <verify>
Verify prompts contain new content:
```bash
grep -q "2-3 sentences" prompts/basic/PROMPT_plan.md && echo "Story sizing: OK"
grep -q "QUALITY CHECKS" prompts/basic/PROMPT_build.md && echo "Quality checks: OK"
grep -q "Learnings:" prompts/basic/PROMPT_build.md && echo "Learnings format: OK"
```
All three checks should print OK.

Verify prompts compile via include_str!:
```bash
cargo build 2>&1 | tail -5
```
Build should succeed (prompts are embedded at compile time via include_str!).
  </verify>
  <done>
PROMPT_plan.md contains "2-3 sentences" story sizing guidance.
PROMPT_build.md contains "QUALITY CHECKS" section.
PROMPT_build.md failure memory format includes "Learnings:" field.
`cargo build` succeeds, confirming prompts compile correctly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add E2E verification tests for portableralph alignment</name>
  <files>
    tests/e2e/test_basic_mode_alignment.rs
    tests/e2e/mod.rs
  </files>
  <action>
Create tests/e2e/test_basic_mode_alignment.rs with three E2E tests verifying portableralph alignment:

1. `test_basic_mode_one_task_per_iteration` - Verify Claude is instructed to do one task per iteration (MODE-03)
   - Use WorkspaceBuilder to create test fixture with progress.md having 2 incomplete tasks
   - Configure FakeClaudeHandle to return a response that completes exactly one task
   - Use `.with_response()` on FakeClaudeHandle for deterministic output
   - Run rslph build with --once flag
   - Assert: Only ONE task marked complete in progress file
   - Assert: progress.md file updated with correct status

2. `test_basic_mode_ralph_done_termination` - Verify RALPH_DONE terminates loop (MODE-03)
   - Use WorkspaceBuilder for fixture setup
   - Configure FakeClaudeHandle to return response containing "RALPH_DONE" in status section
   - Run rslph build (no --once flag)
   - Assert: Command exits with DoneReason::RalphDoneMarker
   - Assert: Build loop terminates cleanly

3. `test_basic_mode_vcs_commit_on_completion` - Verify VCS commit after task completion (MODE-05)
   - Use WorkspaceBuilder to create fixture with git repo initialized
   - Create progress.md with one incomplete task
   - Configure FakeClaudeHandle to complete the task
   - Run single iteration with --once
   - Assert: `git log --oneline` shows new commit
   - Assert: Commit message contains expected format (e.g., "Complete task:")

Use existing patterns from tests/e2e/test_rslph_integration.rs:
- WorkspaceBuilder::new().with_progress_file().with_git_init()
- FakeClaudeHandle::new().with_response(response_content)
- ScenarioBuilder if multi-step scenario needed
- Assert using std assertions, check file contents with std::fs::read_to_string

Add module to tests/e2e/mod.rs:
```rust
mod test_basic_mode_alignment;
```
  </action>
  <verify>
```bash
cd /Users/vmakaev/Non-Work/rslph && cargo test test_basic_mode --no-run 2>&1 | tail -5
```
Tests should compile successfully.

```bash
cd /Users/vmakaev/Non-Work/rslph && cargo test test_basic_mode -- --nocapture 2>&1 | head -30
```
All three tests should pass.
  </verify>
  <done>
test_basic_mode_alignment.rs exists with 3 tests.
Module declared in tests/e2e/mod.rs.
All tests pass: one_task_per_iteration, ralph_done_termination, vcs_commit_on_completion.
Tests verify MODE-03 and MODE-05 behavior is aligned with portableralph.
  </done>
</task>

</tasks>

<verification>
1. Prompt content verification:
   - `grep "2-3 sentences" prompts/basic/PROMPT_plan.md` returns match
   - `grep "QUALITY CHECKS" prompts/basic/PROMPT_build.md` returns match
   - `grep "Learnings:" prompts/basic/PROMPT_build.md` returns match

2. Compilation verification:
   - `cargo build` succeeds (prompts are embedded at compile time via include_str!)

3. Test verification:
   - `cargo test test_basic_mode` runs 3 tests, all pass
</verification>

<success_criteria>
1. Basic mode prompts contain portableralph-aligned guidance:
   - Story sizing (2-3 sentences)
   - Quality checks before marking complete
   - Learnings documentation format

2. E2E tests verify:
   - One task per iteration behavior
   - RALPH_DONE termination
   - VCS commit on task completion

3. All existing tests still pass (`cargo test`)

4. MODE-04 confirmed aligned: progress.md format is semantically equivalent to portableralph's prd.json + progress.txt (both track task descriptions, statuses, and details - no changes needed)
</success_criteria>

<output>
After completion, create `.planning/phases/17-basic-mode-alignment/17-01-SUMMARY.md`
</output>
